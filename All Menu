-- TELEPORT V1.0 by Nazam Official - STEALTH EDITION
-- Anti-Detection System Enhanced

local TweenService = game:GetService("TweenService")
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local HttpService = game:GetService("HttpService")

local TeleportV1 = {
    positions = {},
    maxPositions = 10,
    currentSelected = 1,
    antiCheatBypass = true,
    deleteMode = false,
    menuVisible = true,
    gui = nil,
    mainFrame = nil,
    menuIcon = nil,
    teleporting = false,
    lastTeleport = 0,
    cooldown = 0.5, -- Increased cooldown
    ghostMode = false,
    ghostPaused = false,
    ghostConnection = nil,
    ghostDelay = 0.6, -- Slower ghost mode
    realPosition = nil,
    stealthMode = true, -- New stealth feature
    randomDelay = true -- Random teleport delays
}

local GUI = {
    mainColor = Color3.fromRGB(15, 15, 15), -- Darker for stealth
    secondaryColor = Color3.fromRGB(200, 200, 200), -- Less bright
    accentColor = Color3.fromRGB(150, 0, 0), -- Less vibrant red
    successColor = Color3.fromRGB(0, 120, 0), -- Darker green
    warningColor = Color3.fromRGB(180, 40, 40), -- Less bright red
    ghostColor = Color3.fromRGB(100, 0, 150), -- Darker purple
    pauseColor = Color3.fromRGB(200, 100, 0) -- Darker orange
}

local Sizes = {
    mainFrame = UDim2.new(0, 260, 0, 340), -- Smaller size
    titleHeight = 28,
    posFrameSize = UDim2.new(0.46, 0, 0, 58),
    buttonHeight = 24,
    spacing = 5,
    menuIconSize = 36
}

-- STEALTH ANTI-DETECTION SYSTEM
local function setupStealthProtection()
    if not TeleportV1.stealthMode then return end
    
    -- Randomize script signatures
    local randomId = tostring(math.random(10000, 99999))
    local fakeNames = {
        "PlayerScriptsLoader",
        "UISystemController", 
        "CameraSystem_"..randomId,
        "InputHandler_"..randomId,
        "GuiManager_"..randomId
    }
    
    -- Disable common detection methods
    pcall(function()
        -- Hook metatables for stealth
        if not getgenv().stealthHooked then
            local oldNamecall
            oldNamecall = hookmetamethod(game, "__namecall", function(self, ...)
                local method = getnamecallmethod()
                local args = {...}
                
                -- Stealthy bypass - don't block everything, just modify returns
                if method and tostring(method):lower():find("teleport") then
                    if math.random(1, 3) == 1 then -- Only sometimes bypass
                        return true
                    end
                end
                
                if method and tostring(method):lower():find("check") then
                    if math.random(1, 4) == 1 then -- Random bypass
                        return true
                    end
                end
                
                return oldNamecall(self, ...)
            end)
            
            getgenv().stealthHooked = true
        end
    end)
    
    -- Fake legitimate activity
    spawn(function()
        while TeleportV1.stealthMode and wait(math.random(5, 15)) do
            pcall(function()
                -- Simulate normal player activity
                if Players.LocalPlayer.Character then
                    local humanoid = Players.LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                    if humanoid then
                        -- Random small movements to look legit
                        if math.random(1, 10) == 1 then
                            humanoid:Move(Vector3.new(
                                math.random(-10, 10) / 1000,
                                0,
                                math.random(-10, 10) / 1000
                            ))
                        end
                    end
                end
            end)
        end
    end)
end

local function savePositions()
    if not TeleportV1.stealthMode then return false end
    
    local saveData = {}
    for i, cframe in pairs(TeleportV1.positions) do
        if cframe then
            saveData[tostring(i)] = {
                x = cframe.X, y = cframe.Y, z = cframe.Z,
                rx = cframe.RightVector.X, ry = cframe.RightVector.Y, rz = cframe.RightVector.Z,
                ux = cframe.UpVector.X, uy = cframe.UpVector.Y, uz = cframe.UpVector.Z,
                lx = -cframe.LookVector.X, ly = -cframe.LookVector.Y, lz = -cframe.LookVector.Z
            }
        end
    end
    
    local success = pcall(function()
        writefile("PlayerSettings_"..tostring(math.random(1000,9999))..".dat", HttpService:JSONEncode(saveData))
    end)
    
    return success
end

local function loadPositions()
    if not TeleportV1.stealthMode then return false end
    
    local success = pcall(function()
        for i = 1000, 9999 do
            local filename = "PlayerSettings_"..tostring(i)..".dat"
            if isfile(filename) then
                local data = HttpService:JSONDecode(readfile(filename))
                TeleportV1.positions = {}
                
                for key, value in pairs(data) do
                    local index = tonumber(key)
                    if index then
                        TeleportV1.positions[index] = CFrame.new(
                            value.x, value.y, value.z,
                            value.rx, value.ry, value.rz,
                            value.ux, value.uy, value.uz,
                            value.lx, value.ly, value.lz
                        )
                    end
                end
                
                TeleportV1:updateGUI()
                return true
            end
        end
    end)
    
    return success
end

local function stealthBypass()
    if not TeleportV1.stealthMode then return end
    
    -- More subtle bypass methods
    pcall(function()
        -- Only hook when necessary
        if not getgenv().stealthInitialized then
            -- Minimal hooking to avoid detection
            local oldIndex
            oldIndex = hookmetamethod(game, "__index", function(self, key)
                if TeleportV1.teleporting and tostring(key):lower():find("position") then
                    if math.random(1, 5) == 1 then -- Rarely bypass
                        return oldIndex(self, key)
                    end
                end
                return oldIndex(self, key)
            end)
            
            getgenv().stealthInitialized = true
        end
    end)
    
    -- Network manipulation with delays
    pcall(function()
        local player = Players.LocalPlayer
        if player.Character then
            local rootPart = player.Character:FindFirstChild("HumanoidRootPart")
            if rootPart then
                -- Gradual network changes
                spawn(function()
                    wait(math.random(1, 3) / 10)
                    pcall(function()
                        rootPart:SetNetworkOwner(nil)
                    end)
                end)
            end
        end
    end)
end

local function stabilizeCharacter(character)
    if not character then return end
    
    pcall(function()
        local humanoid = character:FindFirstChildOfClass("Humanoid")
        local rootPart = character:FindFirstChild("HumanoidRootPart")
        
        if humanoid and rootPart then
            -- Gradual stabilization
            rootPart.Anchored = true
            rootPart.Velocity = Vector3.new(0, 0, 0)
            rootPart.RotVelocity = Vector3.new(0, 0, 0)
            
            wait(0.1 + math.random(1, 5) / 100) -- Random delay
            
            rootPart.Anchored = false
            humanoid:ChangeState(Enum.HumanoidStateType.GettingUp)
            
            wait(0.1)
            humanoid:ChangeState(Enum.HumanoidStateType.Landed)
        end
    end)
end

function TeleportV1:stealthTeleport(targetCFrame)
    if not targetCFrame then return false end
    
    -- Anti-cooldown bypass detection
    local currentTime = tick()
    if currentTime - self.lastTeleport < self.cooldown then 
        return false 
    end
    
    self.teleporting = true
    self.lastTeleport = currentTime
    
    local player = Players.LocalPlayer
    local character = player.Character
    
    if not character then 
        self.teleporting = false
        return false 
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if not rootPart or not humanoid then 
        self.teleporting = false
        return false 
    end
    
    -- Apply stealth bypass
    stealthBypass()
    
    -- Gradual teleport with random delays
    pcall(function()
        rootPart.Anchored = true
        rootPart.Velocity = Vector3.new(0, 0, 0)
    end)
    
    local delay = self.randomDelay and math.random(5, 15) / 100 or 0.05
    wait(delay)
    
    -- Multiple small teleports instead of one big one
    local steps = 2
    local stepDistance = (targetCFrame.Position - rootPart.Position) / steps
    
    for i = 1, steps do
        if i < steps then
            local intermediatePos = rootPart.Position + stepDistance
            pcall(function()
                rootPart.CFrame = CFrame.new(intermediatePos, targetCFrame.Position)
            end)
            wait(0.05 + math.random(1, 3) / 100)
        else
            pcall(function()
                rootPart.CFrame = targetCFrame
            end)
        end
    end
    
    wait(0.1)
    stabilizeCharacter(character)
    
    self.teleporting = false
    return true
end

-- GHOST MODE dengan stealth improvements
function TeleportV1:startGhostMode()
    local validPositions = {}
    for i = 1, self.maxPositions do
        if self.positions[i] then
            table.insert(validPositions, i)
        end
    end
    
    if #validPositions < 2 then
        return false
    end
    
    self.ghostMode = true
    self.ghostPaused = false
    
    local player = Players.LocalPlayer
    local currentIndex = 1
    
    local ghostBtn = self.gui:FindFirstChild("GhostBtn", true)
    if ghostBtn then
        ghostBtn.Text = "PAUSE"
        ghostBtn.BackgroundColor3 = GUI.pauseColor
    end
    
    spawn(function()
        while self.ghostMode do
            if not self.ghostPaused then
                local character = player.Character
                if character then
                    local rootPart = character:FindFirstChild("HumanoidRootPart")
                    if rootPart then
                        if not self.realPosition then
                            self.realPosition = rootPart.CFrame
                        end
                        
                        local targetIndex = validPositions[currentIndex]
                        if self.positions[targetIndex] then
                            -- Use stealth teleport for ghost mode
                            self:stealthTeleport(self.positions[targetIndex])
                            
                            wait(self.ghostDelay + math.random(1, 10) / 100) -- Random delays
                            
                            if self.realPosition then
                                self:stealthTeleport(self.realPosition)
                            end
                            
                            currentIndex = currentIndex + 1
                            if currentIndex > #validPositions then
                                currentIndex = 1
                            end
                        end
                    end
                end
            end
            
            wait(self.ghostDelay + math.random(1, 20) / 100) -- Variable delays
        end
    end)
    
    return true
end

-- GUI functions tetap sama dengan improvements stealth
function TeleportV1:createMenuIcon()
    local menuIcon = Instance.new("TextButton")
    menuIcon.Size = UDim2.new(0, Sizes.menuIconSize, 0, Sizes.menuIconSize)
    menuIcon.Position = UDim2.new(0, 10, 0, 10) -- Position lebih subtle
    menuIcon.BackgroundColor3 = GUI.accentColor
    menuIcon.TextColor3 = GUI.secondaryColor
    menuIcon.Text = "⚙" -- Ganti icon jadi lebih normal
    menuIcon.Font = Enum.Font.GothamBold
    menuIcon.TextSize = 14
    menuIcon.AutoButtonColor = true
    menuIcon.Name = "SettingsIcon" -- Ganti nama
    menuIcon.ZIndex = 10
    menuIcon.Visible = false
    menuIcon.Parent = self.gui
    
    local iconCorner = Instance.new("UICorner")
    iconCorner.CornerRadius = UDim.new(0, 6)
    iconCorner.Parent = menuIcon
    
    local iconStroke = Instance.new("UIStroke")
    iconStroke.Color = GUI.secondaryColor
    iconStroke.Thickness = 1.5 -- Lebih tipis
    iconStroke.Parent = menuIcon
    
    -- Drag functionality tetap sama
    local dragging = false
    local dragInput, dragStart, startPos
    
    menuIcon.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = menuIcon.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    menuIcon.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            menuIcon.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    menuIcon.MouseButton1Click:Connect(function()
        self:toggleMenu()
    end)
    
    return menuIcon
end

function TeleportV1:createMainFrame()
    local mainFrame = Instance.new("Frame")
    mainFrame.Size = Sizes.mainFrame
    mainFrame.Position = UDim2.new(0.5, -Sizes.mainFrame.X.Offset/2, 0.5, -Sizes.mainFrame.Y.Offset/2)
    mainFrame.BackgroundColor3 = GUI.mainColor
    mainFrame.BackgroundTransparency = 0.1
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = false
    mainFrame.Visible = true
    mainFrame.Name = "UIPanel" -- Nama lebih generic
    mainFrame.Parent = self.gui
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = mainFrame
    
    local stroke = Instance.new("UIStroke")
    stroke.Color = GUI.accentColor
    stroke.Thickness = 1.5
    stroke.Parent = mainFrame
    
    -- Title bar dengan nama lebih normal
    local titleBar = Instance.new("Frame")
    titleBar.Size = UDim2.new(1, 0, 0, Sizes.titleHeight)
    titleBar.Position = UDim2.new(0, 0, 0, 0)
    titleBar.BackgroundColor3 = GUI.accentColor
    titleBar.BorderSizePixel = 0
    titleBar.Name = "Header"
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 6)
    titleCorner.Parent = titleBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Size = UDim2.new(0.65, 0, 1, 0)
    titleLabel.Position = UDim2.new(0.05, 0, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = GUI.secondaryColor
    titleLabel.Text = "Quick Menu"
    titleLabel.Font = Enum.Font.GothamMedium
    titleLabel.TextSize = 10
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = titleBar
    
    -- Minimize button
    local minimizeBtn = Instance.new("TextButton")
    minimizeBtn.Size = UDim2.new(0, 22, 0, 22)
    minimizeBtn.Position = UDim2.new(1, -26, 0.5, -11)
    minimizeBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    minimizeBtn.TextColor3 = GUI.secondaryColor
    minimizeBtn.Text = "−"
    minimizeBtn.Font = Enum.Font.GothamBold
    minimizeBtn.TextSize = 12
    minimizeBtn.AutoButtonColor = false
    minimizeBtn.Name = "MinimizeBtn"
    minimizeBtn.Parent = titleBar
    
    local minimizeCorner = Instance.new("UICorner")
    minimizeCorner.CornerRadius = UDim.new(0, 4)
    minimizeCorner.Parent = minimizeBtn
    
    minimizeBtn.MouseEnter:Connect(function()
        minimizeBtn.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
    end)
    
    minimizeBtn.MouseLeave:Connect(function()
        minimizeBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    end)
    
    minimizeBtn.MouseButton1Click:Connect(function()
        self:toggleMenu()
    end)
    
    -- Drag functionality
    local dragging = false
    local dragInput, dragStart, startPos
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    titleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            local delta = input.Position - dragStart
            mainFrame.Position = UDim2.new(
                startPos.X.Scale, 
                startPos.X.Offset + delta.X,
                startPos.Y.Scale, 
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    return mainFrame
end

-- [FUNGSI LAINNYA TETAP SAMA DENGAN PENYESUAIAN STEALTH]

function TeleportV1:setPosition(index)
    if index > self.maxPositions then return end
    
    local character = Players.LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        self.positions[index] = character.HumanoidRootPart.CFrame
        self.currentSelected = index
        self:updateGUI()
        if self.stealthMode then
            spawn(function() savePositions() end) -- Save async
        end
    end
end

function TeleportV1:teleportToPosition(index)
    if not self.positions[index] then return end
    self:stealthTeleport(self.positions[index]) -- Use stealth teleport
end

function TeleportV1:deletePosition(index)
    self.positions[index] = nil
    self:updateGUI()
    if self.stealthMode then
        spawn(function() savePositions() end)
    end
end

function TeleportV1:updateGUI()
    for i = 1, self.maxPositions do
        local posLabel = self.gui:FindFirstChild("PosLabel"..i, true)
        local statusIndicator = self.gui:FindFirstChild("StatusIndicator"..i, true)
        
        if posLabel and statusIndicator then
            if self.positions[i] then
                posLabel.Text = "P"..i.." ✓"
                posLabel.TextColor3 = GUI.successColor
                statusIndicator.BackgroundColor3 = GUI.successColor
            else
                posLabel.Text = "P"..i
                posLabel.TextColor3 = GUI.warningColor
                statusIndicator.BackgroundColor3 = GUI.warningColor
            end
        end
    end
end

function TeleportV1:toggleMenu()
    self.menuVisible = not self.menuVisible
    self.mainFrame.Visible = self.menuVisible
    self.menuIcon.Visible = not self.menuVisible
end

function TeleportV1:setupEvents()
    -- [Event setup tetap sama]
    for i = 1, self.maxPositions do
        local setBtn = self.gui:FindFirstChild("SetBtn"..i, true)
        local teleportBtn = self.gui:FindFirstChild("TeleportBtn"..i, true)
        local deleteBtn = self.gui:FindFirstChild("DeleteBtn"..i, true)
        
        if setBtn then
            setBtn.MouseButton1Click:Connect(function()
                self:setPosition(i)
            end)
        end
        
        if teleportBtn then
            teleportBtn.MouseButton1Click:Connect(function()
                self:teleportToPosition(i)
            end)
        end
        
        if deleteBtn then
            deleteBtn.MouseButton1Click:Connect(function()
                self:deletePosition(i)
                deleteBtn.Visible = false
            end)
        end
    end
    
    -- [Control buttons events tetap sama]
end

function TeleportV1:init()
    self.gui = self:createGUI()
    self:setupEvents()
    setupStealthProtection() -- Initialize stealth
    loadPositions()
    
    print("✅ Stealth Teleport System Loaded")
    print("✅ Anti-Detection Features Active")
    print("✅ Random Delays & Stealth Mode Enabled")
end

TeleportV1:init()
